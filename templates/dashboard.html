{% extends "base.html" %}

{% block title %}Dashboard - BUBT Lost and Found System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-styles.css') }}">
{% endblock %}

{% block content %}
<header class="header">
    <nav class="nav">
        <div class="nav-brand">
            <i class="fas fa-search-location"></i>
            <h1>BUBT Lost & Found</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('dashboard') }}" class="nav-link active">Dashboard</a></li>
            {% if is_admin %}
            <li><a href="{{ url_for('create_item') }}" class="nav-link">Create Item</a></li>
            {% endif %}
            <li><a href="{{ url_for('report') }}" class="nav-link">Report Items</a></li>
            <li><a href="{{ url_for('search') }}" class="nav-link">Search Items</a></li>
            <li><a href="{{ url_for('about') }}" class="nav-link">About</a></li>
            {% if is_admin %}
            <li><a href="{{ url_for('admin_files') }}" class="nav-link" style="color: #f59e0b;">
                <i class="fas fa-shield-alt"></i> Admin Files
            </a></li>
            {% endif %}
        </ul>
        <div class="nav-user">
            <span class="user-email" id="user-email">{{ session.get('email', 'user@bubt.edu.bd') }}</span>
            <button class="btn btn-outline btn-sm" onclick="window.location.href='{{ url_for('logout') }}'">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        <div class="nav-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>
</header>

<main class="main">
    <!-- Hero Section -->
    <section class="dashboard-hero">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Welcome to BUBT Lost & Found Dashboard
                </h1>
                <p class="hero-description">
                    Manage your lost and found items and track system activities 
                    with our comprehensive dashboard solution.
                </p>
                <div class="welcome-message">
                    <h3 id="welcome-title">Welcome back, {{ username }}!</h3>
                    <p id="welcome-subtitle">Here's what's happening with your system today.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard" class="dashboard-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">System Overview</h2>
                <div class="section-actions">
                    <button class="btn btn-outline" id="refresh-stats-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    {% if is_admin %}
                    <button class="btn btn-primary" onclick="window.location.href='{{ url_for('create_item') }}'">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-items">{{ total_items }}</h3>
                        <p>Total Items</p>
                        <small class="stat-change positive">Live data</small>
                    </div>
                </div>
                <div class="stat-card lost">
                    <div class="stat-icon lost">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="lost-items">{{ lost_items }}</h3>
                        <p>Lost Items</p>
                        <small class="stat-change negative">Real-time</small>
                    </div>
                </div>
                <div class="stat-card found">
                    <div class="stat-icon found">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="found-items">{{ found_items }}</h3>
                        <p>Found Items</p>
                        <small class="stat-change positive">Real-time</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="total-reports">{{ total_lost_found }}</h3>
                        <p>Total Reports</p>
                        <small class="stat-change positive">Live data</small>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <div id="main-tabs" class="main-tabs">
                <button class="main-tab-btn active" data-tab="overview">Overview</button>
                <button class="main-tab-btn" data-tab="management">Item Management</button>
                <button class="main-tab-btn" data-tab="reports">Reports</button>
            </div>

            <!-- Tab Contents -->
            <div class="main-tab-contents">
                <!-- Overview Tab -->
                <div id="overview-tab" class="main-tab-content active">
                    <div class="overview-grid">
                        <div class="overview-card">
                            <h3><i class="fas fa-history"></i> Recent Activity</h3>
                            <div class="activity-list" id="activity-list">
                                {% if recent_lost_found %}
                                    {% for item in recent_lost_found[:5] %}
                                    <div class="activity-item">
                                        <i class="fas fa-{{ 'exclamation-triangle' if item.status == 'lost' else 'check-circle' }}"></i>
                                        <span>{{ item.status|title }}: {{ item.name }}</span>
                                        <small>{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else item.date.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="activity-item">
                                        <i class="fas fa-info-circle"></i>
                                        <span>No recent activity</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="overview-card">
                            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                            <div class="quick-actions">
                                {% if is_admin %}
                                <button class="btn btn-primary" onclick="window.location.href='{{ url_for('create_item') }}'">
                                    <i class="fas fa-plus"></i> Create New Item
                                </button>
                                {% endif %}
                                <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('search') }}'">
                                    <i class="fas fa-search"></i> Search Items
                                </button>
                                <button class="btn btn-outline" onclick="window.location.href='{{ url_for('report') }}'">
                                    <i class="fas fa-flag"></i> Report Issue
                                </button>
                                {% if is_admin %}
                                <button class="btn btn-warning" onclick="window.location.href='{{ url_for('admin_files') }}'" style="background: #f59e0b; color: white; border-color: #f59e0b;">
                                    <i class="fas fa-shield-alt"></i> Admin Files
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Overview Cards -->
                    <div class="overview-grid">
                        <div class="overview-card">
                            <h3><i class="fas fa-chart-line"></i> System Health</h3>
                            <div class="health-indicators">
                                <div class="health-item">
                                    <span class="health-label">Database</span>
                                    <span class="health-status online">Online</span>
                                </div>
                                <div class="health-item">
                                    <span class="health-label">Storage</span>
                                    <span class="health-status online">85%</span>
                                </div>
                                <div class="health-item">
                                    <span class="health-label">Performance</span>
                                    <span class="health-status warning">Good</span>
                                </div>
                            </div>
                        </div>
                        <div class="overview-card">
                            <h3><i class="fas fa-calendar-alt"></i> Today's Summary</h3>
                            <div class="summary-stats">
                                <div class="summary-item">
                                    <span class="summary-number" id="today-lost">{{ today_lost }}</span>
                                    <span class="summary-label">Items Lost</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-number" id="today-found">{{ today_found }}</span>
                                    <span class="summary-label">Items Found</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Item Management Tab -->
                <div id="management-tab" class="main-tab-content">
                    <div class="module-content" id="item-management">
                        <div class="module-header">
                            <h3>Item Management</h3>
                            <button class="btn btn-primary" onclick="toggleModule('item-management')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                        <div class="module-tab-content active" id="add-item">
                            {% if is_admin %}
                            <form id="add-item-form" class="dashboard-form" method="POST" action="{{ url_for('create_item') }}">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="item-name">Item Name</label>
                                        <input type="text" id="item-name" name="item-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="item-category">Category</label>
                                        <select id="item-category" name="item-category" required>
                                            <option value="">Select Category</option>
                                            <option value="electronics">Electronics</option>
                                            <option value="jewelry">Jewelry</option>
                                            <option value="clothing">Clothing</option>
                                            <option value="documents">Documents</option>
                                            <option value="keys">Keys</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="item-status">Status</label>
                                        <select id="item-status" name="item-status" required>
                                            <option value="">Select Status</option>
                                            <option value="lost">Lost</option>
                                            <option value="found">Found</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="item-date">Date</label>
                                        <input type="date" id="item-date" name="item-date" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="item-location">Location</label>
                                    <input type="text" id="item-location" name="item-location" required>
                                </div>
                                <div class="form-group">
                                    <label for="item-description">Description</label>
                                    <textarea id="item-description" name="item-description" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="item-contact">Contact Information</label>
                                    <input type="email" id="item-contact" name="item-contact" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Item</button>
                            </form>
                            {% else %}
                            <div class="empty-state" style="padding: 40px; text-align: center; color: #64748b;">
                                <i class="fas fa-lock" style="font-size: 3em; margin-bottom: 10px; color: #cbd5e1;"></i>
                                <h3>Admin Access Required</h3>
                                <p>Only admin users can create items. Please contact an administrator.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="main-tab-content">
                    <div class="reports-grid">
                        <div class="module-content" id="lost-products">
                            <div class="module-header">
                                <h3>Lost Items</h3>
                                <button class="btn btn-primary" onclick="toggleModule('lost-products')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                            <div class="module-tab-content active" id="lost-items-content">
                                <div id="lost-items-grid" class="items-grid">
                                    <!-- Lost items loaded via API -->
                                </div>
                            </div>
                        </div>
                        <div class="module-content" id="found-products">
                            <div class="module-header">
                                <h3>Found Items</h3>
                                <button class="btn btn-primary" onclick="toggleModule('found-products')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                            <div class="module-tab-content active" id="found-items-content">
                                <div id="found-items-grid" class="items-grid">
                                    <!-- Found items loaded via API -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
</main>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    // Load lost and found items via API (from LostFoundItem table)
    async function loadItems() {
        try {
            // Fetch lost items
            const lostResponse = await fetch('{{ url_for("search") }}?status=lost');
            const lostText = await lostResponse.text();
            
            // Fetch found items
            const foundResponse = await fetch('{{ url_for("search") }}?status=found');
            const foundText = await foundResponse.text();
            
            // Use the search API endpoint that returns JSON
            const searchLostResponse = await fetch('{{ url_for("api_search") }}?status=lost');
            const lostItems = await searchLostResponse.json();
            
            const searchFoundResponse = await fetch('{{ url_for("api_search") }}?status=found');
            const foundItems = await searchFoundResponse.json();
            
            // Populate lost items grid
            const lostGrid = document.getElementById('lost-items-grid');
            if (lostGrid) {
                if (lostItems.length === 0) {
                    lostGrid.innerHTML = '<div class="empty-state"><p>No lost items reported yet</p></div>';
                } else {
                    lostGrid.innerHTML = lostItems.slice(0, 10).map(item => 
                        `<div class="lost-item-card">
                            <div class="item-card-header">
                                <div class="item-card-title">${escapeHtml(item.name)}</div>
                                <span class="item-card-status lost">LOST</span>
                            </div>
                            <div class="item-card-details">
                                <p><strong>Category:</strong> ${escapeHtml(item.category)}</p>
                                <p><strong>Date Lost:</strong> ${formatDate(item.date)}</p>
                                <p><strong>Location:</strong> ${escapeHtml(item.location)}</p>
                                <p><strong>Contact:</strong> ${escapeHtml(item.contact)}</p>
                                ${item.phone ? `<p><strong>Phone:</strong> ${escapeHtml(item.phone)}</p>` : ''}
                            </div>
                        </div>`
                    ).join('');
                }
            }
            
            // Populate found items grid
            const foundGrid = document.getElementById('found-items-grid');
            if (foundGrid) {
                if (foundItems.length === 0) {
                    foundGrid.innerHTML = '<div class="empty-state"><p>No found items reported yet</p></div>';
                } else {
                    foundGrid.innerHTML = foundItems.slice(0, 10).map(item => 
                        `<div class="found-item-card">
                            <div class="item-card-header">
                                <div class="item-card-title">${escapeHtml(item.name)}</div>
                                <span class="item-card-status found">FOUND</span>
                            </div>
                            <div class="item-card-details">
                                <p><strong>Category:</strong> ${escapeHtml(item.category)}</p>
                                <p><strong>Date Found:</strong> ${formatDate(item.date)}</p>
                                <p><strong>Location:</strong> ${escapeHtml(item.location)}</p>
                                <p><strong>Contact:</strong> ${escapeHtml(item.contact)}</p>
                                ${item.phone ? `<p><strong>Phone:</strong> ${escapeHtml(item.phone)}</p>` : ''}
                            </div>
                        </div>`
                    ).join('');
                }
            }
        } catch (error) {
            console.error('Error loading items:', error);
        }
    }
    
    // Helper functions
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    // Refresh stats button
    document.addEventListener('DOMContentLoaded', function() {
        loadItems();
        
        // Refresh button
        const refreshBtn = document.getElementById('refresh-stats-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                location.reload();
            });
        }
    });
</script>
{% endblock %}

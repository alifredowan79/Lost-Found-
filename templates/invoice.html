<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Invoice - BUBT Lost and Found System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="invoice-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <i class="fas fa-search-location"></i>
                <h1>BUBT Lost & Found</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="create-item.html" class="nav-link">Create Item</a></li>
                <li><a href="report.html" class="nav-link">Report Items</a></li>
                <li><a href="search.html" class="nav-link">Search Items</a></li>
                <li><a href="invoice.html" class="nav-link active">Generate Invoice</a></li>
                <li><a href="about.html" class="nav-link">About</a></li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <main class="main">
        <!-- Hero Section -->
        <section class="hero-section invoice-hero">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Generate Professional Invoices
                    </h1>
                    <p class="hero-description">
                        Create and manage invoices for found items that have been claimed. 
                        Professional templates with automatic calculations and easy export options.
                    </p>
                    <div class="hero-stats">
                        <div class="stat-item">
                            <i class="fas fa-receipt"></i>
                            <span class="stat-number" id="total-invoices-count">0</span>
                            <span class="stat-label">Total Invoices</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-dollar-sign"></i>
                            <span class="stat-number" id="total-revenue">$0.00</span>
                            <span class="stat-label">Total Revenue</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-calendar-check"></i>
                            <span class="stat-number" id="this-month">0</span>
                            <span class="stat-label">This Month</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invoice Section -->
        <section id="invoice" class="invoice-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Invoice Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary" id="export-all-btn">
                            <i class="fas fa-download"></i> Export All
                        </button>
                        <button class="btn btn-primary" id="new-invoice-btn">
                            <i class="fas fa-plus"></i> New Invoice
                        </button>
                    </div>
                </div>

                <div class="invoice-container">
                    <!-- Invoice Form Section -->
                    <div class="invoice-form-section" id="invoice-form-section">
                        <div class="form-header">
                            <h3><i class="fas fa-edit"></i> Create New Invoice</h3>
                            <button class="btn-close" id="close-form-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="invoice-form" class="dashboard-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="invoice-number">
                                        <i class="fas fa-hashtag"></i> Invoice Number
                                    </label>
                                    <input type="text" id="invoice-number" name="invoice-number" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="invoice-date">
                                        <i class="fas fa-calendar"></i> Issue Date
                                    </label>
                                    <input type="date" id="invoice-date" name="invoice-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="due-date">
                                        <i class="fas fa-clock"></i> Due Date
                                    </label>
                                    <input type="date" id="due-date" name="due-date" required>
                                </div>
                                <div class="form-group">
                                    <label for="invoice-status">
                                        <i class="fas fa-info-circle"></i> Status
                                    </label>
                                    <select id="invoice-status" name="invoice-status" required>
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="overdue">Overdue</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4><i class="fas fa-user"></i> Client Information</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="client-name">Client Name</label>
                                        <input type="text" id="client-name" name="client-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="client-email">Email</label>
                                        <input type="email" id="client-email" name="client-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="client-phone">Phone</label>
                                        <input type="tel" id="client-phone" name="client-phone">
                                    </div>
                                    <div class="form-group">
                                        <label for="client-id">Student/Faculty ID</label>
                                        <input type="text" id="client-id" name="client-id">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4><i class="fas fa-box"></i> Item Details</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="invoice-item">Select Found Item</label>
                                        <select id="invoice-item" name="invoice-item" required>
                                            <option value="">Choose a found item</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="item-description">Item Description</label>
                                        <input type="text" id="item-description" name="item-description" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="item-location">Found Location</label>
                                        <input type="text" id="item-location" name="item-location" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="item-date">Found Date</label>
                                        <input type="text" id="item-date" name="item-date" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h4><i class="fas fa-calculator"></i> Fee Structure</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="processing-fee">Processing Fee ($)</label>
                                        <input type="number" id="processing-fee" name="processing-fee" value="5.00" step="0.01" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="storage-fee">Storage Fee ($)</label>
                                        <input type="number" id="storage-fee" name="storage-fee" value="2.00" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="late-fee">Late Fee ($)</label>
                                        <input type="number" id="late-fee" name="late-fee" value="1.00" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="total-amount">Total Amount ($)</label>
                                        <input type="number" id="total-amount" name="total-amount" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="invoice-notes">
                                    <i class="fas fa-sticky-note"></i> Additional Notes
                                </label>
                                <textarea id="invoice-notes" name="invoice-notes" rows="3" 
                                    placeholder="Special instructions, payment terms, or additional information..."></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="preview-invoice-btn">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Generate Invoice
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Invoice List Section -->
                    <div class="invoice-list-section">
                        <div class="list-header">
                            <h3><i class="fas fa-list"></i> Generated Invoices</h3>
                            <div class="list-filters">
                                <select id="status-filter" class="filter-select">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <input type="text" id="search-invoices" class="search-input" placeholder="Search invoices...">
                            </div>
                        </div>
                        
                        <div class="invoices-grid" id="invoices-grid">
                            <!-- Invoices will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invoice Preview Modal -->
        <div id="invoice-preview-modal" class="modal">
            <div class="modal-content invoice-preview-content">
                <div class="modal-header">
                    <h3><i class="fas fa-eye"></i> Invoice Preview</h3>
                    <button class="btn-close" id="close-preview-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="invoice-preview-content">
                        <!-- Invoice preview will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="print-invoice-btn">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-primary" id="download-invoice-btn">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Invoice-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            initializeInvoicePage();
        });

        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'index.html';
            }
        }

        function initializeInvoicePage() {
            // Set default dates
            const today = new Date();
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 30);
            
            document.getElementById('invoice-date').value = today.toISOString().split('T')[0];
            document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];
            
            // Generate invoice number
            generateInvoiceNumber();
            
            // Load found items
            loadFoundItems();
            
            // Load existing invoices
            loadInvoices();
            
            // Setup event listeners
            setupEventListeners();
            
            // Calculate initial total
            calculateTotal();
        }

        function generateInvoiceNumber() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            const invoiceNumber = `INV-${timestamp}-${random}`;
            document.getElementById('invoice-number').value = invoiceNumber;
        }

        function loadFoundItems() {
            const select = document.getElementById('invoice-item');
            select.innerHTML = '<option value="">Choose a found item</option>';
            
            // Get found items from localStorage or use sample data
            const items = JSON.parse(localStorage.getItem('foundItems')) || sampleItems.filter(item => item.status === 'found');
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} - ${item.location}`;
                option.dataset.item = JSON.stringify(item);
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Form submission
            document.getElementById('invoice-form').addEventListener('submit', handleInvoiceSubmit);
            
            // Item selection
            document.getElementById('invoice-item').addEventListener('change', handleItemSelection);
            
            // Fee calculations
            document.getElementById('processing-fee').addEventListener('input', calculateTotal);
            document.getElementById('storage-fee').addEventListener('input', calculateTotal);
            document.getElementById('late-fee').addEventListener('input', calculateTotal);
            
            // Buttons
            document.getElementById('new-invoice-btn').addEventListener('click', showInvoiceForm);
            document.getElementById('close-form-btn').addEventListener('click', hideInvoiceForm);
            document.getElementById('preview-invoice-btn').addEventListener('click', previewInvoice);
            document.getElementById('export-all-btn').addEventListener('click', exportAllInvoices);
            
            // Modal
            document.getElementById('close-preview-btn').addEventListener('click', closePreviewModal);
            document.getElementById('print-invoice-btn').addEventListener('click', printInvoice);
            document.getElementById('download-invoice-btn').addEventListener('click', downloadInvoice);
            
            // Filters
            document.getElementById('status-filter').addEventListener('change', filterInvoices);
            document.getElementById('search-invoices').addEventListener('input', filterInvoices);
        }

        function handleItemSelection() {
            const select = document.getElementById('invoice-item');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const item = JSON.parse(selectedOption.dataset.item);
                document.getElementById('item-description').value = item.description;
                document.getElementById('item-location').value = item.location;
                document.getElementById('item-date').value = item.date;
            } else {
                document.getElementById('item-description').value = '';
                document.getElementById('item-location').value = '';
                document.getElementById('item-date').value = '';
            }
        }

        function calculateTotal() {
            const processingFee = parseFloat(document.getElementById('processing-fee').value) || 0;
            const storageFee = parseFloat(document.getElementById('storage-fee').value) || 0;
            const lateFee = parseFloat(document.getElementById('late-fee').value) || 0;
            
            const total = processingFee + storageFee + lateFee;
            document.getElementById('total-amount').value = total.toFixed(2);
        }

        function handleInvoiceSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const invoiceData = {
                id: Date.now(),
                number: formData.get('invoice-number'),
                date: formData.get('invoice-date'),
                dueDate: formData.get('due-date'),
                status: formData.get('invoice-status'),
                client: {
                    name: formData.get('client-name'),
                    email: formData.get('client-email'),
                    phone: formData.get('client-phone'),
                    id: formData.get('client-id')
                },
                item: {
                    id: formData.get('invoice-item'),
                    description: formData.get('item-description'),
                    location: formData.get('item-location'),
                    date: formData.get('item-date')
                },
                fees: {
                    processing: parseFloat(formData.get('processing-fee')),
                    storage: parseFloat(formData.get('storage-fee')),
                    late: parseFloat(formData.get('late-fee')),
                    total: parseFloat(formData.get('total-amount'))
                },
                notes: formData.get('invoice-notes'),
                createdAt: new Date().toISOString()
            };
            
            // Save invoice
            saveInvoice(invoiceData);
            
            // Reset form
            e.target.reset();
            generateInvoiceNumber();
            calculateTotal();
            
            // Hide form and show success message
            hideInvoiceForm();
            showNotification('Invoice generated successfully!', 'success');
        }

        function saveInvoice(invoiceData) {
            let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            invoices.push(invoiceData);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Reload invoices list
            loadInvoices();
        }

        function loadInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const grid = document.getElementById('invoices-grid');
            
            if (invoices.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <h4>No Invoices Yet</h4>
                        <p>Create your first invoice to get started</p>
                        <button class="btn btn-primary" onclick="showInvoiceForm()">
                            <i class="fas fa-plus"></i> Create Invoice
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = invoices.map(invoice => createInvoiceCard(invoice)).join('');
            updateStats(invoices);
        }

        function createInvoiceCard(invoice) {
            const statusClass = `status-${invoice.status}`;
            const statusIcon = getStatusIcon(invoice.status);
            
            return `
                <div class="invoice-card ${statusClass}" data-id="${invoice.id}">
                    <div class="card-header">
                        <div class="invoice-number">
                            <i class="fas fa-hashtag"></i>
                            ${invoice.number}
                        </div>
                        <div class="invoice-status ${statusClass}">
                            <i class="${statusIcon}"></i>
                            ${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="client-info">
                            <h4><i class="fas fa-user"></i> ${invoice.client.name}</h4>
                            <p><i class="fas fa-envelope"></i> ${invoice.client.email}</p>
                            <p><i class="fas fa-phone"></i> ${invoice.client.phone || 'N/A'}</p>
                        </div>
                        
                        <div class="item-info">
                            <h5><i class="fas fa-box"></i> ${invoice.item.description}</h5>
                            <p><i class="fas fa-map-marker-alt"></i> ${invoice.item.location}</p>
                        </div>
                        
                        <div class="fee-info">
                            <div class="fee-item">
                                <span>Processing:</span>
                                <span>$${invoice.fees.processing.toFixed(2)}</span>
                            </div>
                            <div class="fee-item">
                                <span>Storage:</span>
                                <span>$${invoice.fees.storage.toFixed(2)}</span>
                            </div>
                            <div class="fee-item total">
                                <span>Total:</span>
                                <span>$${invoice.fees.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="dates">
                            <span><i class="fas fa-calendar"></i> ${formatDate(invoice.date)}</span>
                            <span><i class="fas fa-clock"></i> Due: ${formatDate(invoice.dueDate)}</span>
                        </div>
                        <div class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewInvoice(${invoice.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editInvoice(${invoice.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusIcon(status) {
            const icons = {
                pending: 'fas fa-clock',
                paid: 'fas fa-check-circle',
                overdue: 'fas fa-exclamation-triangle',
                cancelled: 'fas fa-times-circle'
            };
            return icons[status] || 'fas fa-info-circle';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function updateStats(invoices) {
            const totalInvoices = invoices.length;
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.fees.total, 0);
            const thisMonth = invoices.filter(inv => {
                const invDate = new Date(inv.date);
                const now = new Date();
                return invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('total-invoices-count').textContent = totalInvoices;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('this-month').textContent = thisMonth;
        }

        function showInvoiceForm() {
            document.getElementById('invoice-form-section').style.display = 'block';
            document.getElementById('new-invoice-btn').style.display = 'none';
        }

        function hideInvoiceForm() {
            document.getElementById('invoice-form-section').style.display = 'none';
            document.getElementById('new-invoice-btn').style.display = 'inline-flex';
        }

        function previewInvoice() {
            const modal = document.getElementById('invoice-preview-modal');
            const previewContent = document.getElementById('invoice-preview-content');
            
            // Generate preview HTML
            const previewHTML = generateInvoicePreview();
            previewContent.innerHTML = previewHTML;
            
            modal.style.display = 'block';
        }

        function generateInvoicePreview() {
            const form = document.getElementById('invoice-form');
            const formData = new FormData(form);
            
            return `
                <div class="invoice-preview">
                    <div class="invoice-header">
                        <div class="company-info">
                            <h2>BUBT Lost & Found System</h2>
                            <p>Bangladesh University of Business and Technology</p>
                            <p>Dhaka, Bangladesh</p>
                        </div>
                        <div class="invoice-details">
                            <h1>INVOICE</h1>
                            <p><strong>Invoice #:</strong> ${formData.get('invoice-number')}</p>
                            <p><strong>Date:</strong> ${formData.get('invoice-date')}</p>
                            <p><strong>Due Date:</strong> ${formData.get('due-date')}</p>
                        </div>
                    </div>
                    
                    <div class="invoice-body">
                        <div class="client-section">
                            <h3>Bill To:</h3>
                            <p><strong>${formData.get('client-name')}</strong></p>
                            <p>${formData.get('client-email')}</p>
                            <p>${formData.get('client-phone') || 'N/A'}</p>
                            <p>ID: ${formData.get('client-id') || 'N/A'}</p>
                        </div>
                        
                        <div class="items-section">
                            <h3>Item Details:</h3>
                            <p><strong>${formData.get('item-description') || 'N/A'}</strong></p>
                            <p>Location: ${formData.get('item-location') || 'N/A'}</p>
                            <p>Found Date: ${formData.get('item-date') || 'N/A'}</p>
                        </div>
                        
                        <div class="fees-section">
                            <h3>Fee Breakdown:</h3>
                            <div class="fee-row">
                                <span>Processing Fee:</span>
                                <span>$${formData.get('processing-fee')}</span>
                            </div>
                            <div class="fee-row">
                                <span>Storage Fee:</span>
                                <span>$${formData.get('storage-fee')}</span>
                            </div>
                            <div class="fee-row">
                                <span>Late Fee:</span>
                                <span>$${formData.get('late-fee')}</span>
                            </div>
                            <div class="fee-row total">
                                <span><strong>Total Amount:</strong></span>
                                <span><strong>$${formData.get('total-amount')}</strong></span>
                            </div>
                        </div>
                        
                        <div class="notes-section">
                            <h3>Notes:</h3>
                            <p>${formData.get('invoice-notes') || 'No additional notes'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function closePreviewModal() {
            document.getElementById('invoice-preview-modal').style.display = 'none';
        }

        function printInvoice() {
            const printContent = document.getElementById('invoice-preview-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Invoice Print</title>
                        <link rel="stylesheet" href="styles.css">
                        <style>
                            body { margin: 20px; }
                            .modal-header, .modal-footer, .btn { display: none; }
                        </style>
                    </head>
                    <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function downloadInvoice() {
            // Simple PDF download simulation
            showNotification('PDF download started...', 'info');
        }

        function exportAllInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            if (invoices.length === 0) {
                showNotification('No invoices to export', 'warning');
                return;
            }
            
            const csvContent = generateCSV(invoices);
            downloadCSV(csvContent, 'invoices-export.csv');
            showNotification('Invoices exported successfully!', 'success');
        }

        function generateCSV(invoices) {
            const headers = ['Invoice #', 'Date', 'Client', 'Email', 'Item', 'Total Amount', 'Status'];
            const rows = invoices.map(inv => [
                inv.number,
                inv.date,
                inv.client.name,
                inv.client.email,
                inv.item.description,
                `$${inv.fees.total.toFixed(2)}`,
                inv.status
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function filterInvoices() {
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-invoices').value.toLowerCase();
            
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const filtered = invoices.filter(invoice => {
                const matchesStatus = !statusFilter || invoice.status === statusFilter;
                const matchesSearch = !searchTerm || 
                    invoice.number.toLowerCase().includes(searchTerm) ||
                    invoice.client.name.toLowerCase().includes(searchTerm) ||
                    invoice.item.description.toLowerCase().includes(searchTerm);
                
                return matchesStatus && matchesSearch;
            });
            
            displayFilteredInvoices(filtered);
        }

        function displayFilteredInvoices(invoices) {
            const grid = document.getElementById('invoices-grid');
            
            if (invoices.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h4>No Invoices Found</h4>
                        <p>Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = invoices.map(invoice => createInvoiceCard(invoice)).join('');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Additional utility functions
        function viewInvoice(id) {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                // Populate form with invoice data for viewing
                populateFormForView(invoice);
                showInvoiceForm();
            }
        }

        function editInvoice(id) {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                // Populate form with invoice data for editing
                populateFormForEdit(invoice);
                showInvoiceForm();
            }
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                invoices = invoices.filter(inv => inv.id !== id);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                loadInvoices();
                showNotification('Invoice deleted successfully!', 'success');
            }
        }

        function populateFormForView(invoice) {
            // Populate form fields for viewing (read-only)
            document.getElementById('invoice-number').value = invoice.number;
            document.getElementById('invoice-date').value = invoice.date;
            document.getElementById('due-date').value = invoice.dueDate;
            document.getElementById('invoice-status').value = invoice.status;
            document.getElementById('client-name').value = invoice.client.name;
            document.getElementById('client-email').value = invoice.client.email;
            document.getElementById('client-phone').value = invoice.client.phone || '';
            document.getElementById('client-id').value = invoice.client.id || '';
            document.getElementById('item-description').value = invoice.item.description;
            document.getElementById('item-location').value = invoice.item.location;
            document.getElementById('item-date').value = invoice.item.date;
            document.getElementById('processing-fee').value = invoice.fees.processing;
            document.getElementById('storage-fee').value = invoice.fees.storage;
            document.getElementById('late-fee').value = invoice.fees.late;
            document.getElementById('total-amount').value = invoice.fees.total;
            document.getElementById('invoice-notes').value = invoice.notes || '';
            
            // Make form read-only
            makeFormReadOnly(true);
        }

        function populateFormForEdit(invoice) {
            // Populate form fields for editing
            populateFormForView(invoice);
            // Make form editable
            makeFormReadOnly(false);
        }

        function makeFormReadOnly(readOnly) {
            const form = document.getElementById('invoice-form');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.id !== 'invoice-number') { // Keep invoice number always read-only
                    input.readOnly = readOnly;
                    input.disabled = readOnly;
                }
            });
            
            // Update button text
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = readOnly ? 
                    '<i class="fas fa-eye"></i> View Only' : 
                    '<i class="fas fa-save"></i> Generate Invoice';
                submitBtn.disabled = readOnly;
                submitBtn.type = readOnly ? 'button' : 'submit';
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('invoice-preview-modal');
            if (e.target === modal) {
                closePreviewModal();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Items - BUBT Lost and Found System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search-styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <i class="fas fa-search-location"></i>
                <h1>BUBT Lost & Found</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a></li>
                <li><a href="{{ url_for('create_item') }}" class="nav-link">Create Item</a></li>
                <li><a href="{{ url_for('report') }}" class="nav-link">Report Items</a></li>
                <li><a href="{{ url_for('search') }}" class="nav-link active">Search Items</a></li>
                <li><a href="{{ url_for('invoice') }}" class="nav-link">Generate Invoice</a></li>
                <li><a href="{{ url_for('about') }}" class="nav-link">About</a></li>
            </ul>
            <div class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <main class="main">
        <!-- Hero Section -->
        <section class="search-hero">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="fas fa-search"></i>
                    Search Items
                </h1>
                <p class="hero-description">
                    Find your lost items or discover what others have found in our comprehensive database
                </p>
            </div>
        </section>

        <!-- Search Section -->
        <section id="search" class="search-section">
            <div class="container">
                <h2 class="section-title">Search & Filter</h2>
                <p class="section-description">Use the search tools below to find exactly what you're looking for</p>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action-btn active" data-filter="all">
                        <i class="fas fa-th-large"></i> All Items
                    </button>
                    <button class="quick-action-btn" data-filter="lost">
                        <i class="fas fa-exclamation-triangle"></i> Lost Items
                    </button>
                    <button class="quick-action-btn" data-filter="found">
                        <i class="fas fa-check-circle"></i> Found Items
                    </button>
                    <button class="quick-action-btn" data-filter="recent">
                        <i class="fas fa-clock"></i> Recent Items
                    </button>
                </div>

                <!-- Search and Filter Controls -->
                <div class="search-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search by item name, description, or location...">
                        <button class="search-btn" onclick="performSearch()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div class="filter-controls">
                        <select id="filter-category">
                            <option value="">All Categories</option>
                            <option value="electronics">Electronics</option>
                            <option value="jewelry">Jewelry</option>
                            <option value="clothing">Clothing</option>
                            <option value="documents">Documents</option>
                            <option value="keys">Keys</option>
                            <option value="books">Books</option>
                            <option value="bags">Bags & Backpacks</option>
                            <option value="watches">Watches</option>
                            <option value="other">Other</option>
                        </select>
                        <select id="filter-status">
                            <option value="">All Status</option>
                            <option value="lost">Lost</option>
                            <option value="found">Found</option>
                        </select>
                        <button class="clear-filters-btn" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    
                    <!-- Advanced Filters Toggle -->
                    <button class="toggle-advanced" onclick="toggleAdvancedFilters()">
                        <i class="fas fa-chevron-down"></i> Advanced Filters
                    </button>
                    
                    <!-- Advanced Filters -->
                    <div class="advanced-filters" id="advanced-filters">
                        <h4><i class="fas fa-sliders-h"></i> Advanced Search Options</h4>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="filter-date-from">Date From</label>
                                <input type="date" id="filter-date-from">
                            </div>
                            <div class="filter-group">
                                <label for="filter-date-to">Date To</label>
                                <input type="date" id="filter-date-to">
                            </div>
                            <div class="filter-group">
                                <label for="filter-location">Location</label>
                                <input type="text" id="filter-location" placeholder="Building, floor, room...">
                            </div>
                        </div>
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="filter-color">Color</label>
                                <input type="text" id="filter-color" placeholder="Item color...">
                            </div>
                            <div class="filter-group">
                                <label for="filter-brand">Brand/Model</label>
                                <input type="text" id="filter-brand" placeholder="Brand or model...">
                            </div>
                            <div class="filter-group">
                                <label for="filter-value">Max Value (BDT)</label>
                                <input type="number" id="filter-value" placeholder="Maximum value...">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="search-results">
                    <!-- Results Header -->
                    <div class="results-header">
                        <div class="results-count">
                            Showing <span id="results-count">0</span> items
                        </div>
                        <div class="sort-controls">
                            <label for="sort-by">Sort by:</label>
                            <select id="sort-by" onchange="sortResults()">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="category">Category</option>
                                <option value="status">Status</option>
                            </select>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loading-state" class="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Searching for items...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-search"></i>
                        <h3>No items found</h3>
                        <p>Try adjusting your search criteria or filters to find what you're looking for.</p>
                        <button class="btn btn-primary" onclick="clearFilters()">
                            <i class="fas fa-refresh"></i> Clear All Filters
                        </button>
                    </div>

                    <!-- Items Grid -->
                    <div id="items-grid" class="items-grid">
                        <!-- Items will be populated by JavaScript -->
                    </div>

                    <!-- Pagination -->
                    <div id="pagination" class="pagination" style="display: none;">
                        <!-- Pagination buttons will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Global variables
        let allItems = [];
        let filteredItems = [];
        let currentPage = 1;
        const itemsPerPage = 12;

        // Initialize search page
        document.addEventListener('DOMContentLoaded', function() {
            // Check login status first
            checkLoginStatus();
            
            // Initialize search functionality
            initializeSearch();
            
            // Load sample data
            loadSampleData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Perform initial search
            performSearch();
        });

        // Check if user is logged in
        function checkLoginStatus() {
            // Flask already handles authentication, so this check is not needed
            // But we can keep it for client-side validation if needed
            // Authentication is handled by Flask session in the backend
        }

        // Initialize search functionality
        function initializeSearch() {
            // Set current date for date filters
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filter-date-to').value = today;
            
            // Set date from 30 days ago
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('filter-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Load sample data
        function loadSampleData() {
            if (typeof sampleItems !== 'undefined') {
                allItems = [...sampleItems];
            } else {
                // Fallback sample data if script.js is not loaded
                allItems = [
                    {
                        id: 1,
                        name: "iPhone 13 Pro",
                        category: "electronics",
                        status: "lost",
                        date: "2024-01-15",
                        location: "Main Library, 2nd Floor",
                        description: "Gold iPhone 13 Pro with clear case",
                        color: "Gold",
                        brand: "Apple",
                        value: 120000
                    },
                    {
                        id: 2,
                        name: "Gold Necklace",
                        category: "jewelry",
                        status: "found",
                        date: "2024-01-14",
                        location: "Student Center",
                        description: "Delicate gold necklace with small pendant",
                        color: "Gold",
                        brand: "Unknown",
                        value: 25000
                    },
                    {
                        id: 3,
                        name: "Samsung Galaxy Watch",
                        category: "electronics",
                        status: "lost",
                        date: "2024-01-13",
                        location: "Gymnasium",
                        description: "Black Samsung Galaxy Watch 4",
                        color: "Black",
                        brand: "Samsung",
                        value: 35000
                    }
                ];
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Search input with debouncing
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, 500);
            });

            // Filter changes
            document.getElementById('filter-category').addEventListener('change', performSearch);
            document.getElementById('filter-status').addEventListener('change', performSearch);
            document.getElementById('filter-date-from').addEventListener('change', performSearch);
            document.getElementById('filter-date-to').addEventListener('change', performSearch);
            document.getElementById('filter-location').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('filter-color').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('filter-brand').addEventListener('input', debounce(performSearch, 500));
            document.getElementById('filter-value').addEventListener('input', debounce(performSearch, 500));

            // Quick action buttons
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.quick-action-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Apply quick filter
                    const filter = this.dataset.filter;
                    applyQuickFilter(filter);
                });
            });
        }

        // Perform search with all filters
        function performSearch() {
            showLoading();
            
            setTimeout(() => {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const category = document.getElementById('filter-category').value;
                const status = document.getElementById('filter-status').value;
                const dateFrom = document.getElementById('filter-date-from').value;
                const dateTo = document.getElementById('filter-date-to').value;
                const location = document.getElementById('filter-location').value.toLowerCase();
                const color = document.getElementById('filter-color').value.toLowerCase();
                const brand = document.getElementById('filter-brand').value.toLowerCase();
                const maxValue = document.getElementById('filter-value').value;

                // Filter items
                filteredItems = allItems.filter(item => {
                    // Search term filter
                    const matchesSearch = !searchTerm || 
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.description.toLowerCase().includes(searchTerm) ||
                        item.location.toLowerCase().includes(searchTerm);

                    // Category filter
                    const matchesCategory = !category || item.category === category;

                    // Status filter
                    const matchesStatus = !status || item.status === status;

                    // Date range filter
                    const itemDate = new Date(item.date);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo) : null;
                    
                    const matchesDate = (!fromDate || itemDate >= fromDate) && 
                                     (!toDate || itemDate <= toDate);

                    // Location filter
                    const matchesLocation = !location || 
                        item.location.toLowerCase().includes(location);

                    // Color filter
                    const matchesColor = !color || 
                        (item.color && item.color.toLowerCase().includes(color));

                    // Brand filter
                    const matchesBrand = !brand || 
                        (item.brand && item.brand.toLowerCase().includes(brand));

                    // Value filter
                    const matchesValue = !maxValue || 
                        (item.value && item.value <= parseInt(maxValue));

                    return matchesSearch && matchesCategory && matchesStatus && 
                           matchesDate && matchesLocation && matchesColor && 
                           matchesBrand && matchesValue;
                });

                // Sort results
                sortResults();
                
                // Update display
                updateResultsDisplay();
                hideLoading();
            }, 500); // Simulate search delay
        }

        // Apply quick filter
        function applyQuickFilter(filter) {
            switch(filter) {
                case 'lost':
                    document.getElementById('filter-status').value = 'lost';
                    break;
                case 'found':
                    document.getElementById('filter-status').value = 'found';
                    break;
                case 'recent':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    document.getElementById('filter-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
                    break;
                default:
                    document.getElementById('filter-status').value = '';
                    document.getElementById('filter-date-from').value = '';
            }
            
            performSearch();
        }

        // Sort results
        function sortResults() {
            const sortBy = document.getElementById('sort-by').value;
            
            filteredItems.sort((a, b) => {
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'category':
                        return a.category.localeCompare(b.category);
                    case 'status':
                        return a.status.localeCompare(b.status);
                    default:
                        return 0;
                }
            });
        }

        // Update results display
        function updateResultsDisplay() {
            const resultsCount = document.getElementById('results-count');
            const itemsGrid = document.getElementById('items-grid');
            const emptyState = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');

            resultsCount.textContent = filteredItems.length;

            if (filteredItems.length === 0) {
                itemsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }

            itemsGrid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Calculate pagination
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredItems.slice(startIndex, endIndex);

            // Display items
            displayItems(pageItems);

            // Update pagination
            if (totalPages > 1) {
                displayPagination(totalPages);
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        }

        // Display items in grid
        function displayItems(items) {
            const itemsGrid = document.getElementById('items-grid');
            
            itemsGrid.innerHTML = items.map(item => `
                <div class="item-card ${item.status} fade-in" onclick="viewItemDetails(${item.id})">
                    <div class="item-header">
                        <h3 class="item-title">${item.name}</h3>
                        <span class="item-status ${item.status}">${item.status.toUpperCase()}</span>
                    </div>
                    
                    <div class="item-category">
                        <i class="${getCategoryIcon(item.category)}"></i>
                        ${getCategoryName(item.category)}
                    </div>
                    
                    <div class="item-details">
                        <div class="item-detail">
                            <i class="fas fa-calendar"></i>
                            <span>${formatDate(item.date)}</span>
                        </div>
                        <div class="item-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${item.location}</span>
                        </div>
                        ${item.color ? `<div class="item-detail">
                            <i class="fas fa-palette"></i>
                            <span>${item.color}</span>
                        </div>` : ''}
                        ${item.brand ? `<div class="item-detail">
                            <i class="fas fa-tag"></i>
                            <span>${item.brand}</span>
                        </div>` : ''}
                        ${item.value ? `<div class="item-detail">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>${item.value.toLocaleString()} BDT</span>
                        </div>` : ''}
                    </div>
                    
                    <div class="item-description">${item.description}</div>
                    
                    <div class="item-footer">
                        <span class="item-date">${formatDate(item.date)}</span>
                        <div class="item-actions">
                            <button class="btn-sm btn-outline" onclick="event.stopPropagation(); contactOwner(${item.id})">
                                <i class="fas fa-envelope"></i> Contact
                            </button>
                            <button class="btn-sm btn-primary" onclick="event.stopPropagation(); viewItemDetails(${item.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display pagination
        function displayPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            // Next button
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            updateResultsDisplay();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-color').value = '';
            document.getElementById('filter-brand').value = '';
            document.getElementById('filter-value').value = '';
            
            // Reset quick action buttons
            document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.quick-action-btn[data-filter="all"]').classList.add('active');
            
            // Reset to first page
            currentPage = 1;
            
            // Perform search
            performSearch();
        }

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advanced-filters');
            const toggleBtn = document.querySelector('.toggle-advanced');
            
            if (advancedFilters.classList.contains('show')) {
                advancedFilters.classList.remove('show');
                toggleBtn.classList.remove('active');
            } else {
                advancedFilters.classList.add('show');
                toggleBtn.classList.add('active');
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('items-grid').style.display = 'none';
            document.getElementById('empty-state').style.display = 'none';
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('loading-state').style.display = 'none';
        }

        // Utility functions
        function getCategoryIcon(category) {
            const iconMap = {
                'electronics': 'fas fa-laptop',
                'jewelry': 'fas fa-gem',
                'clothing': 'fas fa-tshirt',
                'documents': 'fas fa-file-alt',
                'keys': 'fas fa-key',
                'books': 'fas fa-book',
                'bags': 'fas fa-briefcase',
                'watches': 'fas fa-clock',
                'other': 'fas fa-question-circle'
            };
            return iconMap[category] || 'fas fa-question-circle';
        }

        function getCategoryName(category) {
            const nameMap = {
                'electronics': 'Electronics',
                'jewelry': 'Jewelry',
                'clothing': 'Clothing',
                'documents': 'Documents',
                'keys': 'Keys',
                'books': 'Books',
                'bags': 'Bags & Backpacks',
                'watches': 'Watches',
                'other': 'Other'
            };
            return nameMap[category] || 'Other';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Placeholder functions for future implementation
        function viewItemDetails(itemId) {
            alert(`Viewing details for item ${itemId}. This feature will be implemented soon!`);
        }

        function contactOwner(itemId) {
            alert(`Contacting owner of item ${itemId}. This feature will be implemented soon!`);
        }
    </script>
</body>
</html>
